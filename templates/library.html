<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Library</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f9; margin: 0; padding: 40px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .book-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .book-title { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .book-meta { color: #666; font-size: 0.9em; margin-bottom: 15px; }
        .btn { display: inline-block; background: #3498db; color: white; text-decoration: none; padding: 8px 15px; border-radius: 4px; font-size: 0.9em; }
        .btn:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Library</h1>

        {% if directories %}
            <div class="book-grid">
                {% for folder in directories %}
                <div class="book-card">
                    <div class="book-title">{{ folder.name }}</div>
                    <div class="book-meta">
                        {{ folder.path }}
                    </div>
                    <a href="/?dir_index={{ folder.index }}" class="btn">Open Folder</a>
                </div>
                {% endfor %}
            </div>
        {% else %}
            {% if not books %}
                <p>No processed books found. Run <code>reader3.py</code> on an epub first.</p>
            {% endif %}

            <div class="book-grid" id="bookGrid" style="visibility: hidden;">
                {% for book in books %}
                <div class="book-card" data-book-id="{{ book.id }}">
                    <div class="book-title">{{ book.title }}</div>
                    <div class="book-meta">
                        {{ book.author }}<br>
                        {{ book.chapters }} sections
                    </div>
                    <div class="book-progress" style="font-size: 0.85em; color: #27ae60; margin-bottom: 10px; font-weight: bold; min-height: 1.2em;"></div>
                    <a href="/read/{{ book.id }}/0" class="btn read-btn">Read Book</a>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const grid = document.getElementById('bookGrid');
            if (!grid) return;

            const progressData = JSON.parse(localStorage.getItem('reader3_progress') || '{}');
            const cards = Array.from(grid.querySelectorAll('.book-card'));

            // Update cards with progress info
            cards.forEach(card => {
                const bookId = card.getAttribute('data-book-id');
                const data = progressData[bookId];

                if (data) {
                    // Update Link
                    const btn = card.querySelector('.read-btn');
                    if (btn) {
                        btn.href = `/read/${bookId}/${data.chapterIndex}`;
                        btn.textContent = "Resume Reading";
                    }

                    // Update Progress Text
                    const progressDiv = card.querySelector('.book-progress');
                    if (progressDiv) {
                        progressDiv.textContent = `Progress: ${data.percent}%`;
                        progressDiv.style.display = 'block';
                    }
                    
                    // Attach timestamp for sorting
                    card.dataset.timestamp = data.timestamp;
                } else {
                    card.dataset.timestamp = 0;
                }
            });

            // Sort cards: Recent first (descending timestamp)
            cards.sort((a, b) => {
                return b.dataset.timestamp - a.dataset.timestamp;
            });

            // Re-append to grid
            cards.forEach(card => grid.appendChild(card));

            // Show grid
            grid.style.visibility = 'visible';
        });
    </script>
</body>
</html>
